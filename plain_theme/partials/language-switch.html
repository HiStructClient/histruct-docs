{% set cur = page.file.locale %}
{% set cur_lang = (i18n_config.languages | selectattr("locale","equalto",cur) | first) %}

<div class="lang-switch">
  <button class="lang-btn"
          aria-label="Change language"
          popovertarget="lang-menu"
          popovertargetaction="toggle">
    {{ cur_lang.name if cur_lang else cur|upper }}
    <svg class="chev" viewBox="0 0 10 6" aria-hidden="true">
      <path d="M1 1l4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.7"/>
    </svg>
  </button>

  <div id="lang-menu" class="lang-popover" popover role="listbox" aria-label="Languages">
    <ul>
      {% for lang in i18n_config.languages %}
        {% set alt = page.file.alternates.get(lang.locale) %}
        {% if alt %}
          <li>
            <a role="option"
               aria-selected="{{ 'true' if lang.locale == cur else 'false' }}"
               class="lang-item {{ 'is-active' if lang.locale == cur }}"
               href="{{ alt.dest_uri|url }}"
               hreflang="{{ lang.locale }}">
              {{ lang.name }}
            </a>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
</div>